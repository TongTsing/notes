## NAT 模式

![img](https://pic2.zhimg.com/80/v2-ec0e901aa34213683d1264551f1db021_1440w.webp)

红色表示发出的数据包；绿色表示返回的数据包；黄色表示负载均衡器修改的内容；虚线表示经过 N 个下一跳，即可以不在同一局域网内；实线表示只能 “跳跃一次”，即必须在同一局域网；

1. 当计算机发出一个请求的数据包到达负载均衡器后，负载均衡器将发送数据包的 { 目标 IP 地址、端口号、目标 MAC 地址 } 转换为 { 某台真实服务器的 IP 地址、真实服务的端口号、真实服务器的 MAC 地址 } ，其余信息不变。这种只转换数据包的目标设备信息，而不修改数据包的源设备信息，称之为 DNAT，即目标网络地址转换。
2. 真实服务器收到请求的数据包，返回响应的数据包：{ 某台真实服务器的 IP 地址、真实服务的端口号、真实服务器的 MAC 地址 } ➡️ { 原始请求的 IP 地址、端口号、跳跃的 MAC 地址 } 。所以此时在服务器上查看 TCP 连接为：CIP ➡️ RIP。
3. 真实服务器返回的数据包的 “下一个目的地” 必须是负载均衡器。如果返回数据包直接返回给客户端，客户端发现返回数据包的源设备信息和发出数据包的目标设备信息不一致，将会丢弃返回数据包。所以真实服务器的默认网关必须是 DIP，保证返回数据包的 “下一个目的地” 是负载均衡器。
4. 当返回的数据包到达负载均衡器后，负载均衡器将返回数据包的 { 原始请求的 IP 地址、端口号、跳跃的 MAC 地址 } 转换为原始请求的 { 目标 IP 地址、端口号、目标 MAC 地址 } 。这种只转换数据包的源设备信息，而不修改数据包的目标设备信息，称之为 SNAT，即源网络地址转换。
5. 负载均衡器返回数据包给客户端。

**总结一下 NAT 模式的特点：**

1. **修改数据包的「源 IP 地址」或 「目标 IP 地址」，可以对端口进行转发**
2. **真实服务器的默认网关必须是负载均衡器，所以真实服务器和负载均衡器必须在同一个局域网内**
3. **所有的请求数据包、响应数据包都要经过负载均衡器**
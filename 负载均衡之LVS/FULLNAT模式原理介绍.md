## FULLNAT 模式

NAT 模式中，负载均衡器和真实服务器必须在同一局域网内，但在实际的开发过程中，真实服务器可能分布在不同的网段，甚至不同的城市。如何能将 NAT 模式应用在真实服务器分布在不同网段的场景下？

![img](https://pic3.zhimg.com/80/v2-2a5aed7ece4d02b7f70f9316a46fe29a_1440w.webp)

红色表示发出的数据包；绿色表示返回的数据包；黄色表示负载均衡器修改的内容；虚线表示经过 N 个下一跳，即可以不在同一局域网内；实线表示只能 “跳跃一次”，即必须在同一局域网；

1. 当计算机发出一个请求的数据包到达负载均衡器后，负载均衡器会对请求数据包同时做 SNAT 和 DNAT，将请求数据包修改为：{ 均衡出口 IP 地址、端口号、负载均衡器的 MAC 地址 } ➡️ { 某台真实服务器的 IP 地址、真实服务的端口号、真实服务器的 MAC 地址 }。
2. 这样负载均衡器就可以独立的和真实服务器进行数据包的传送
3. 真实服务器收到请求的数据包，返回响应的数据包：{ 某台真实服务器的 IP 地址、真实服务的端口号、真实服务器的 MAC 地址 } ➡️ { 负载均衡器的 IP 地址、端口号、负载均衡器的 MAC 地址 } 。此时在真实服务器上查看 TCP 连接为：DIP ➡️ RIP。
4. 当返回的数据包到达负载均衡器后，负载均衡器将返回数据包再次同时做 DNAT 和 SNAT。
5. 负载均衡器返回数据包给客户端。

**总结一下FULL NAT 模式的特点：**

1. **同时修改数据包的「源 IP 地址」和「目标 IP 地址」，可以对端口进行转发**
2. **负载均衡器不需要以网关的形式存在，即负载均衡器可以和真实服务器在不同的网络中**
3. **真实服务器最终建立的连接是 DIP ➡️ RIP，无法获取真实客户端的 IP 地址**
4. **所有的请求数据包、响应数据包都要经过负载均衡器**

LVS 本身不支持 FULLNAT 模式，需要额外对内核打补丁后才能使用。

------

可以看到在 NAT 和 FULLNAT 模式中，不管是请求数据包还是响应数据包，都要经过负载均衡器。但是响应数据包一般要比请求数据包大很多，这可能会成为系统的瓶颈。如果能够将请求数据包转发到真实服务器之后，响应数据包由真实服务器直接返回，这样对负载均衡器的压力就小很多。这种模式又该如何实现